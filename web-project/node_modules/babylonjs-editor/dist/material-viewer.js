!function(e){function t(e){Object.defineProperty(this,e,{enumerable:!0,get:function(){return this[v][e]}})}function r(e){if("undefined"!=typeof System&&System.isModule?System.isModule(e):"[object Module]"===Object.prototype.toString.call(e))return e;var t={default:e,__useDefault:e};if(e&&e.__esModule)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return new o(t)}function o(e){Object.defineProperty(this,v,{value:e}),Object.keys(e).forEach(t,this)}function n(e){return"@node/"===e.substr(0,6)?c(e,r(m(e.substr(6))),{}):p[e]}function u(e){var t=n(e);if(!t)throw new Error('Module "'+e+'" expected, but not contained in build.');if(t.module)return t.module;var r=t.linkRecord;return i(t,r),a(t,r,[]),t.module}function i(e,t){if(!t.depLoads){t.declare&&d(e,t),t.depLoads=[];for(var r=0;r<t.deps.length;r++){var o=n(t.deps[r]);t.depLoads.push(o),o.linkRecord&&i(o,o.linkRecord);var u=t.setters&&t.setters[r];u&&(u(o.module||o.linkRecord.moduleObj),o.importerSetters.push(u))}return e}}function d(t,r){var o=r.moduleObj,n=t.importerSetters,u=!1,i=r.declare.call(e,function(e,t){if(!u){if("object"==typeof e)for(var r in e)"__useDefault"!==r&&(o[r]=e[r]);else o[e]=t;u=!0;for(var i=0;i<n.length;i++)n[i](o);return u=!1,t}},{id:t.key});"function"!=typeof i?(r.setters=i.setters,r.execute=i.execute):(r.setters=[],r.execute=i)}function l(e,t,r){return p[e]={key:e,module:void 0,importerSetters:[],linkRecord:{deps:t,depLoads:void 0,declare:r,setters:void 0,execute:void 0,moduleObj:{}}}}function f(e,t,r,o){var n={};return p[e]={key:e,module:void 0,importerSetters:[],linkRecord:{deps:t,depLoads:void 0,declare:void 0,execute:o,executingRequire:r,moduleObj:{default:n,__useDefault:n},setters:void 0}}}function s(e,t,r){return function(o){for(var n=0;n<e.length;n++)if(e[n]===o){var u,i=t[n],d=i.linkRecord;return u=d?-1===r.indexOf(i)?a(i,d,r):d.moduleObj:i.module,"__useDefault"in u?u.__useDefault:u}}}function a(t,r,n){if(n.push(t),t.module)return t.module;if(r.setters){for(var i=0;i<r.deps.length;i++){var d=r.depLoads[i],l=d.linkRecord;l&&-1===n.indexOf(d)&&a(d,l,l.setters?n:[])}r.execute.call(y)}else{var f={id:t.key},c=r.moduleObj;Object.defineProperty(f,"exports",{configurable:!0,set:function(e){c.default=c.__useDefault=e},get:function(){return c.__useDefault}});var p=s(r.deps,r.depLoads,n);if(!r.executingRequire)for(var i=0;i<r.deps.length;i++)p(r.deps[i]);var v=r.execute.call(e,p,c.__useDefault,f);void 0!==v?c.default=c.__useDefault=v:f.exports!==c.__useDefault&&(c.default=c.__useDefault=f.exports);var m=c.__useDefault;if(m&&m.__esModule)for(var b in m)Object.hasOwnProperty.call(m,b)&&(c[b]=m[b])}var f=t.module=new o(r.moduleObj);if(!r.setters)for(var i=0;i<t.importerSetters.length;i++)t.importerSetters[i](f);return f}function c(e,t){return p[e]={key:e,module:t,importerSetters:[],linkRecord:void 0}}var p={},v="undefined"!=typeof Symbol?Symbol():"@@baseObject";o.prototype=Object.create(null),"undefined"!=typeof Symbol&&Symbol.toStringTag&&(o.prototype[Symbol.toStringTag]="Module");var m="undefined"!=typeof System&&System._nodeRequire||"undefined"!=typeof require&&void 0!==require.resolve&&"undefined"!=typeof process&&process.platform&&require,y={};return Object.freeze&&Object.freeze(y),function(e,t,n,i){return function(d){d(function(d){var s={_nodeRequire:m,register:l,registerDynamic:f,registry:{get:function(e){return p[e].module},set:c},newModule:function(e){return new o(e)}};c("@empty",new o({}));for(var a=0;a<t.length;a++)c(t[a],r(arguments[a],{}));i(s);var v=u(e[0]);if(e.length>1)for(var a=1;a<e.length;a++)u(e[a]);return n?v.__useDefault:(v instanceof o&&Object.defineProperty(v,"__esModule",{value:!0}),v)})}}}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this)(["a"],["b","c"],!0,function($__System){this.require,this.exports,this.module;$__System.registerDynamic("a",["b","c"],!0,function($__require,exports,module){"use strict";var __extends=(this||self,exports&&exports.__extends||function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}()),__awaiter=exports&&exports.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=exports&&exports.__generator||function(thisArg,body){function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(t=_.trys,!(t=t.length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g};Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("b"),babylonjs_editor_1=$__require("c"),MaterialsViewer=function(_super){function MaterialsViewer(editor,targetObject){var _this=_super.call(this,"Materials Viewer")||this;return _this.editor=editor,_this.images=[],_this.layout=null,_this.toolbar=null,_this.preview=null,_this.tempPreview=null,_this.canvas=null,_this.engines=[],_this.onObjectSelected=function(obj){return _this.selectedObject(obj)},_this.waitingMaterials=[],_this.onAddObject=function(material){return _this.waitingMaterials.push(material)},_this.targetObject=targetObject,_this}return __extends(MaterialsViewer,_super),MaterialsViewer.prototype.close=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return this.engines.forEach(function(e){e.scenes.forEach(function(s){return s.dispose()}),e.dispose()}),this.editor.core.onAddObject.removeCallback(this.onAddObject),this.editor.core.onSelectObject.removeCallback(this.onObjectSelected),this.canvas.remove(),this.preview.scene.dispose(),this.preview.engine.dispose(),this.tempPreview.scene.dispose(),this.tempPreview.engine.dispose(),this.toolbar.element.destroy(),this.layout.element.destroy(),[4,_super.prototype.close.call(this)];case 1:return _a.sent(),[2]}})})},MaterialsViewer.prototype.create=function(){return __awaiter(this,void 0,void 0,function(){var panelSize,div,_this=this;return __generator(this,function(_a){return panelSize=this.editor.resizableLayout.getPanelSize(this.name),div=$(this.divElement),this.layout=new babylonjs_editor_1.Layout("MaterialViewer"),this.layout.panels=[{type:"top",content:'<div id="MATERIAL-VIEWER-TOOLBAR"></div>',size:30,resizable:!1},{type:"left",content:'<div id="MATERIAL-VIEWER-LIST"></div>',size:panelSize.width/2,overflow:"auto",resizable:!0},{type:"main",content:'<canvas id="MATERIAL-VIEWER-CANVAS" style="position: absolute; padding: 15px; width: 100%; height: 100%;"></canvas>',resizable:!0}],this.layout.build(div.attr("id")),this.toolbar=new babylonjs_editor_1.Toolbar("MaterialViewerToolbar"),this.toolbar.items=[{id:"add",text:"Add...",caption:"Add...",img:"icon-add"},{id:"refresh",text:"Refresh",caption:"Refresh",img:"w2ui-icon-reload"}],this.toolbar.helpUrl="http://doc.babylonjs.com/resources/adding_materials",this.toolbar.onClick=function(target){return _this.toolbarClicked(target)},this.toolbar.build("MATERIAL-VIEWER-TOOLBAR"),this.preview=this.createPreview($("#MATERIAL-VIEWER-CANVAS")[0]),this.preview.engine.runRenderLoop(function(){return _this.preview.scene.render()}),this.canvas=babylonjs_editor_1.Tools.CreateElement("canvas","MaterialsViewerCanvas",{width:"100px",height:"100px",visibility:"hidden"}),div.append(this.canvas),this.tempPreview=this.createPreview(this.canvas),this.createList(),this.layout.element.on({execute:"after",type:"resize"},function(){return _this.preview.engine.resize()}),this.editor.core.onAddObject.add(this.onAddObject),this.editor.core.onSelectObject.add(this.onObjectSelected),this.selectedObject(this.targetObject),[2]})})},MaterialsViewer.prototype.onShow=function(targetObject){return __awaiter(this,void 0,void 0,function(){var _i,_a,m;return __generator(this,function(_b){switch(_b.label){case 0:_i=0,_a=this.waitingMaterials,_b.label=1;case 1:return _i<_a.length?(m=_a[_i],[4,this.createPreviewNode($("#MATERIAL-VIEWER-LIST"),this.canvas,this.tempPreview,m)]):[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return this.waitingMaterials=[],this.onResize(),this.targetObject=targetObject,this.selectedObject(targetObject),[2]}})})},MaterialsViewer.prototype.onResize=function(){this.layout.element.resize(),this.preview.engine.resize(),_super.prototype.resizeLayout.call(this,this.layout,["left"],["main"])},MaterialsViewer.prototype.selectedObject=function(obj){this.targetObject=obj instanceof babylonjs_1.AbstractMesh&&obj!==this.targetObject?null:this.targetObject,this.toolbar.notifyMessage(this.targetObject?"<h2>"+this.targetObject.name+"</h2> Selected":"")},MaterialsViewer.prototype.toolbarClicked=function(target){switch(target){case"add":this.createMaterialDialog();break;case"refresh":this.createList()}},MaterialsViewer.prototype.createList=function(){return __awaiter(this,void 0,void 0,function(){var div,scene,_i,_a,mat;return __generator(this,function(_b){switch(_b.label){case 0:for(div=$("#MATERIAL-VIEWER-LIST");div[0].children.length>0;)div[0].children[0].remove();scene=this.editor.core.scene,_i=0,_a=scene.materials,_b.label=1;case 1:return _i<_a.length?(mat=_a[_i],[4,this.createPreviewNode(div,this.canvas,this.tempPreview,mat)]):[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})},MaterialsViewer.prototype.createPreviewNode=function(div,canvas,preview,material){return __awaiter(this,void 0,void 0,function(){var parent,text,img,base64,dropListener,_this=this;return __generator(this,function(_a){switch(_a.label){case 0:return material instanceof babylonjs_1.ShaderMaterial?[2]:(parent=babylonjs_editor_1.Tools.CreateElement("div",material.id+"div",{width:"100px",height:"100px",float:"left",margin:"10px"}),text=babylonjs_editor_1.Tools.CreateElement("small",material.id+"text",{float:"left",width:"100px",left:"50%",top:"8px",transform:"translate(-50%, -50%)","text-overflow":"ellipsis","white-space":"nowrap",overflow:"hidden",position:"relative"}),text.innerText=material.name,img=babylonjs_editor_1.Tools.CreateElement("img",material.id,{width:"100px",height:"100px"}),img.classList.add("ctxmenu"),babylonjs_editor_1.ContextMenu.ConfigureElement(img,{clone:{name:"Clone",callback:function(){var newMaterial=material.clone(material.name+" Cloned");newMaterial.id=babylonjs_1.Tools.RandomId(),babylonjs_1.Tags.AddTagsTo(newMaterial,"added"),_this.createPreviewNode(div,canvas,preview,newMaterial)}},remove:{name:"Remove",callback:function(){material.dispose(!0,!1,!1),parent.remove()}}}),parent.appendChild(img),parent.appendChild(text),[4,this.createMaterialPreview(canvas,preview,material)]);case 1:return base64=_a.sent(),img.src=base64,img.addEventListener("click",function(ev){var obj=material.serialize();obj._customCode=null,_this.preview.sphere.material=babylonjs_1.Material.Parse(obj,_this.preview.scene,"file:"),_this.preview.engine.resize(),_this.editor.core.onSelectObject.notifyObservers(material),_this.targetObject&&(_this.targetObject.material=material)}),dropListener=this.dragEnd(material),img.addEventListener("dragstart",function(){_this.editor.core.engine.getRenderingCanvas().addEventListener("drop",dropListener)}),img.addEventListener("dragend",function(){_this.editor.core.engine.getRenderingCanvas().removeEventListener("drop",dropListener)}),div.append(parent),[2]}})})},MaterialsViewer.prototype.createPreview=function(canvas,material){var engine=new babylonjs_1.Engine(canvas),scene=new babylonjs_1.Scene(engine);scene.clearColor.set(0,0,0,1);var camera=new babylonjs_1.ArcRotateCamera("MaterialViewerCamera",1,1,15,babylonjs_1.Vector3.Zero(),scene);camera.attachControl(canvas);var sphere=babylonjs_1.Mesh.CreateSphere("MaterialViewerSphere",32,6,scene),light=new babylonjs_1.PointLight("MaterialViewerLight",new babylonjs_1.Vector3(20,20,20),scene);if(material){var obj=material.serialize();sphere.material=babylonjs_1.Material.Parse(obj,scene,"file:")}return{engine:engine,scene:scene,camera:camera,sphere:sphere,material:material,light:light}},MaterialsViewer.prototype.createMaterialPreview=function(canvas,preview,mat){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,new Promise(function(resolve){var obj=mat.serialize();preview.sphere.material=babylonjs_1.Material.Parse(obj,preview.scene,"file:"),preview.scene.render(),preview.scene.executeWhenReady(function(){preview.scene.render(),preview.scene.onReadyObservable.clear();var base64=canvas.toDataURL("image/png");resolve(base64)})})]})})},MaterialsViewer.prototype.dragEnd=function(material){var _this=this;return function(ev){var scene=_this.editor.core.scene,pick=scene.pick(ev.offsetX,ev.offsetY);pick.pickedMesh&&(pick.pickedMesh instanceof babylonjs_1.InstancedMesh?(pick.pickedMesh.sourceMesh.material=material,babylonjs_editor_1.UndoRedo.Push({object:pick.pickedMesh.sourceMesh,property:"material",from:pick.pickedMesh.sourceMesh.material,to:material})):pick.pickedMesh instanceof babylonjs_1.Mesh&&(babylonjs_editor_1.UndoRedo.Push({object:pick.pickedMesh,property:"material",from:pick.pickedMesh.material,to:material}),pick.pickedMesh.material=material),_this.editor.core.onSelectObject.notifyObservers(pick.pickedMesh))}},MaterialsViewer.prototype.createMaterialDialog=function(){var _this=this,materials=["StandardMaterial","PBRMaterial","PBRMetallicRoughnessMaterial","PBRSpecularGlossinessMaterial","FireMaterial","CellMaterial","GridMaterial","TriPlanarMaterial","TerrainMaterial","LavaMaterial","MixMaterial"],picker=new babylonjs_editor_1.Picker("Select Material...");picker.addItems(materials.map(function(m){return{name:m}})),picker.open(function(items){return __awaiter(_this,void 0,void 0,function(){var ctor,material;return __generator(this,function(_a){switch(_a.label){case 0:return ctor=babylonjs_1.Tools.Instantiate("BABYLON."+items[0].name),material=new ctor(items[0].name+babylonjs_1.Tools.RandomId().substr(0,5),this.editor.core.scene),babylonjs_1.Tags.AddTagsTo(material,"added"),[4,this.createPreviewNode($("#MATERIAL-VIEWER-LIST"),this.canvas,this.tempPreview,material)];case 1:return _a.sent(),[2]}})})})},MaterialsViewer}(babylonjs_editor_1.EditorPlugin);exports.default=MaterialsViewer})})(function(factory){module.exports=factory(require("babylonjs"),require("babylonjs-editor"))});