!function(e){function t(e){Object.defineProperty(this,e,{enumerable:!0,get:function(){return this[v][e]}})}function r(e){if("undefined"!=typeof System&&System.isModule?System.isModule(e):"[object Module]"===Object.prototype.toString.call(e))return e;var t={default:e,__useDefault:e};if(e&&e.__esModule)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return new o(t)}function o(e){Object.defineProperty(this,v,{value:e}),Object.keys(e).forEach(t,this)}function n(e){return"@node/"===e.substr(0,6)?c(e,r(m(e.substr(6))),{}):p[e]}function u(e){var t=n(e);if(!t)throw new Error('Module "'+e+'" expected, but not contained in build.');if(t.module)return t.module;var r=t.linkRecord;return i(t,r),a(t,r,[]),t.module}function i(e,t){if(!t.depLoads){t.declare&&d(e,t),t.depLoads=[];for(var r=0;r<t.deps.length;r++){var o=n(t.deps[r]);t.depLoads.push(o),o.linkRecord&&i(o,o.linkRecord);var u=t.setters&&t.setters[r];u&&(u(o.module||o.linkRecord.moduleObj),o.importerSetters.push(u))}return e}}function d(t,r){var o=r.moduleObj,n=t.importerSetters,u=!1,i=r.declare.call(e,function(e,t){if(!u){if("object"==typeof e)for(var r in e)"__useDefault"!==r&&(o[r]=e[r]);else o[e]=t;u=!0;for(var i=0;i<n.length;i++)n[i](o);return u=!1,t}},{id:t.key});"function"!=typeof i?(r.setters=i.setters,r.execute=i.execute):(r.setters=[],r.execute=i)}function l(e,t,r){return p[e]={key:e,module:void 0,importerSetters:[],linkRecord:{deps:t,depLoads:void 0,declare:r,setters:void 0,execute:void 0,moduleObj:{}}}}function f(e,t,r,o){var n={};return p[e]={key:e,module:void 0,importerSetters:[],linkRecord:{deps:t,depLoads:void 0,declare:void 0,execute:o,executingRequire:r,moduleObj:{default:n,__useDefault:n},setters:void 0}}}function s(e,t,r){return function(o){for(var n=0;n<e.length;n++)if(e[n]===o){var u,i=t[n],d=i.linkRecord;return u=d?-1===r.indexOf(i)?a(i,d,r):d.moduleObj:i.module,"__useDefault"in u?u.__useDefault:u}}}function a(t,r,n){if(n.push(t),t.module)return t.module;if(r.setters){for(var i=0;i<r.deps.length;i++){var d=r.depLoads[i],l=d.linkRecord;l&&-1===n.indexOf(d)&&a(d,l,l.setters?n:[])}r.execute.call(y)}else{var f={id:t.key},c=r.moduleObj;Object.defineProperty(f,"exports",{configurable:!0,set:function(e){c.default=c.__useDefault=e},get:function(){return c.__useDefault}});var p=s(r.deps,r.depLoads,n);if(!r.executingRequire)for(var i=0;i<r.deps.length;i++)p(r.deps[i]);var v=r.execute.call(e,p,c.__useDefault,f);void 0!==v?c.default=c.__useDefault=v:f.exports!==c.__useDefault&&(c.default=c.__useDefault=f.exports);var m=c.__useDefault;if(m&&m.__esModule)for(var b in m)Object.hasOwnProperty.call(m,b)&&(c[b]=m[b])}var f=t.module=new o(r.moduleObj);if(!r.setters)for(var i=0;i<t.importerSetters.length;i++)t.importerSetters[i](f);return f}function c(e,t){return p[e]={key:e,module:t,importerSetters:[],linkRecord:void 0}}var p={},v="undefined"!=typeof Symbol?Symbol():"@@baseObject";o.prototype=Object.create(null),"undefined"!=typeof Symbol&&Symbol.toStringTag&&(o.prototype[Symbol.toStringTag]="Module");var m="undefined"!=typeof System&&System._nodeRequire||"undefined"!=typeof require&&void 0!==require.resolve&&"undefined"!=typeof process&&process.platform&&require,y={};return Object.freeze&&Object.freeze(y),function(e,t,n,i){return function(d){d(function(d){var s={_nodeRequire:m,register:l,registerDynamic:f,registry:{get:function(e){return p[e].module},set:c},newModule:function(e){return new o(e)}};c("@empty",new o({}));for(var a=0;a<t.length;a++)c(t[a],r(arguments[a],{}));i(s);var v=u(e[0]);if(e.length>1)for(var a=1;a<e.length;a++)u(e[a]);return n?v.__useDefault:(v instanceof o&&Object.defineProperty(v,"__esModule",{value:!0}),v)})}}}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this)(["a"],["d","17","11","10","12","13","e"],!0,function($__System){this.require,this.exports,this.module;$__System.registerDynamic("b",[],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var TokenType;!function(TokenType){TokenType[TokenType.IDENTIFIER=0]="IDENTIFIER",TokenType[TokenType.PARENTHESIS=1]="PARENTHESIS",TokenType[TokenType.COMMA=2]="COMMA",TokenType[TokenType.UNKNOWN=3]="UNKNOWN",TokenType[TokenType.END_OF_INPUT=4]="END_OF_INPUT"}(TokenType=exports.TokenType||(exports.TokenType={}));var Tokenizer=function(){function Tokenizer(toParse){this.identifier="",this.token=TokenType.UNKNOWN,this._pos=0,this._isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this.toParse=toParse,this._maxPos=toParse.length,this.getNextToken()}return Tokenizer.prototype.read=function(){return this.toParse[this._pos++]},Tokenizer.prototype.peek=function(){return this.toParse[this._pos]},Tokenizer.prototype.forward=function(){this._pos++},Tokenizer.prototype.isEnd=function(){return this._pos>=this._maxPos},Tokenizer.prototype.match=function(token){return this.token===token&&(this.getNextToken(),!0)},Tokenizer.prototype.matchIdentifier=function(expected){return this.identifier===expected&&(this.getNextToken(),!0)},Tokenizer.prototype.getNextToken=function(){if(this.isEnd())return this.token=TokenType.END_OF_INPUT;for(var c=" ";" "===(c=this.read())||"\t"===c;)if(this.isEnd())return this.token=TokenType.END_OF_INPUT;switch(c){case"(":case")":return this.token=TokenType.PARENTHESIS;case",":return this.token=TokenType.COMMA;default:if("_"===c||this._isLetterOrDigitPattern.test(c)){for(this.token=TokenType.IDENTIFIER,this.identifier=c;!this.isEnd()&&(this._isLetterOrDigitPattern.test(c=this.peek())||"_"===c||"."===c);)this.identifier+=c,this.forward();return this.token=TokenType.IDENTIFIER}}return this.token=TokenType.UNKNOWN},Tokenizer}();exports.default=Tokenizer}),$__System.registerDynamic("c",["d","e"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("d"),extensions_1=$__require("e"),Tools=function(){function Tools(){}return Tools.prototype.getCustomMaterial=function(name){var ext=extensions_1.default.Instances.MaterialCreatorExtension;return ext?ext.instances[name]:null},Tools.prototype.getCustomScript=function(object,name){var ext=extensions_1.default.Instances.BehaviorExtension;return ext?"string"===(typeof object).toLowerCase()?ext.instances[object+name]:object instanceof babylonjs_1.Scene?ext.instances["scene"+name]:object instanceof babylonjs_1.ParticleSystem?ext.instances[object.id+name]:ext.instances[object.name+name]:null},Tools.prototype.getConstructor=function(name){var ext=extensions_1.default.Instances.BehaviorExtension;return ext?ext.scriptsConstructors[name]:null},Tools.prototype.getCustomPostProcess=function(name){var ext=extensions_1.default.Instances.PostProcessCreatorExtension;return ext?ext.instances[name]:null},Tools.prototype.getFileByName=function(name){return babylonjs_1.FilesInputStore.FilesToLoad[name]},Tools.prototype.getFileUrl=function(filename,oneTimeOnly){return void 0===oneTimeOnly&&(oneTimeOnly=!0),extensions_1.default.RoolUrl&&"file:"!==extensions_1.default.RoolUrl?extensions_1.default.RoolUrl+filename:URL.createObjectURL(this.getFileByName(filename))},Tools.prototype.getPathFinder=function(name){var ext=extensions_1.default.Instances.PathFinderExtension;return ext?ext.instances[name]:null},Tools.prototype.instantiatePrefab=function(name){return extensions_1.default.Instances.AssetsExtension.instantiatePrefab(name)},Tools.prototype.instantiateParticleSystemSet=function(name,position){return extensions_1.default.Instances.AssetsExtension.instantiateParticleSystemsSet(name,position)},Tools.prototype.sendMessage=function(object,methodName){for(var params=[],_i=2;_i<arguments.length;_i++)params[_i-2]=arguments[_i];var ext=extensions_1.default.Instances.BehaviorExtension;if(!ext)return null;var scripts=ext.objectsInstances[object instanceof babylonjs_1.Scene?"Scene":object.id];scripts&&scripts.forEach(function(s){return s[methodName]&&s[methodName].apply(s,params)})},Tools}();exports.default=Tools;var exportScriptBodyString="\n    if (!params) {\n        returnValue = value;\n    } else {\n        returnValue = {\n            ctor: value\n        };\n\n        var keys = Object.keys(params);\n        for (var i = 0; i < keys.length; i++) {\n            returnValue[keys[i]] = params[keys[i]];\n        }\n    }\n".replace(/\n/g,"").replace(/\t/g,"").replace(/  /g,""),exportScriptReturnString="\nif (returnValue) {return returnValue;}\nif (exports) {return exports;}\n".replace(/\n/g,"").replace(/\t/g,"").replace(/  /g,"");exports.exportScriptString="\nfunction exportScript (value, params) {"+exportScriptBodyString+"};\n"+exportScriptReturnString+"\n"}),$__System.registerDynamic("f",["d","10","11","12","13","14"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var BABYLON=$__require("d"),POSTPROCESS=$__require("10"),GUI=$__require("11"),CANNON=$__require("12"),EARCUT=$__require("13"),code_1=$__require("14");exports.defineRequire=function(){window.require||(window.require=function(name){return exports.editorRequire(name)})},exports.editorRequire=function(moduleName){switch(moduleName){case"babylonjs":case"babylonjs-procedural-textures":case"babylonjs-loaders":case"babylonjs-materials":return BABYLON;case"babylonjs-post-process":return POSTPROCESS;case"babylonjs-gui":return GUI;case"cannon":return CANNON;case"earcut":return EARCUT;default:var ctor=EDITOR.BehaviorCode.Constructors[moduleName];if(ctor){for(var args=new Array(ctor.length),i=0;i<args.length;i++)args[i]=exports.editorRequire;return ctor.apply(ctor,args)}if(ctor=EDITOR.BehaviorCode.Constructors[moduleName.replace(/ /g,"")])return ctor.apply(new Array(ctor.length).map(function(_){return exports.editorRequire}));var code=code_1.default.Instance.datas.scripts.find(function(s){return s.name===moduleName});if(!code)throw new Error('Cannot find custom module named "'+moduleName+'"');return ctor=code_1.default.Instance.getConstructor(code,null),ctor.default=ctor,ctor}}}),$__System.registerDynamic("15",[],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var Extension=function(){function Extension(scene){this.alwaysApply=!1,this.scene=scene}return Extension.AddScript=function(code,url){var script=document.createElement("script");return script.type="text/javascript",script.text=code+"\n//# sourceURL="+url+"\n",document.head.appendChild(script),script},Extension}();exports.default=Extension}),$__System.registerDynamic("14",["d","b","c","f","e","15"],!0,function($__require,exports,module){"use strict";var __extends=(this||self,exports&&exports.__extends||function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}()),__awaiter=exports&&exports.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=exports&&exports.__generator||function(thisArg,body){function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(t=_.trys,!(t=t.length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g};Object.defineProperty(exports,"__esModule",{value:!0});var EDITOR,babylonjs_1=$__require("d"),tokenizer_1=$__require("b"),tools_1=$__require("c"),require_1=$__require("f"),extensions_1=$__require("e"),extension_1=$__require("15"),template="\nEDITOR.BehaviorCode.Constructors['{{name}}'] = function (scene, {{node}}, tools, mobile, require) {\nvar returnValue = null;\nvar exports = { };\n\n{{code}}\n"+tools_1.exportScriptString+"\n}\n";!function(EDITOR){var BehaviorCode=function(){function BehaviorCode(){}return BehaviorCode.Constructors={},BehaviorCode}();EDITOR.BehaviorCode=BehaviorCode}(EDITOR=exports.EDITOR||(exports.EDITOR={})),window.EDITOR=window.EDITOR||{},window.EDITOR.BehaviorCode=EDITOR.BehaviorCode;var CodeExtension=function(_super){function CodeExtension(scene){var _this=_super.call(this,scene)||this;return _this.id="behavior-editor",_this.assetsCaption="Scripts",_this.instances={},_this.scriptsConstructors={},_this.objectsInstances={},_this.datas=null,CodeExtension.Instance=_this,_this}return __extends(CodeExtension,_super),CodeExtension.prototype.onCreateAsset=function(name){return __awaiter(this,void 0,void 0,function(){var code,asset;return __generator(this,function(_a){switch(_a.label){case 0:return[4,new Promise(function(resolve){babylonjs_1.Tools.LoadFile("assets/templates/code/custom-code-typescript.ts",function(data){return resolve(data)})})];case 1:return code=_a.sent(),asset={name:name,data:{code:code.replace(/{{name}}/g,(name[0].toUpperCase()+name.substr(1,name.length)).replace(/ /g,"")),id:babylonjs_1.Tools.RandomId(),name:name}},this.scene.metadata=this.scene.metadata||{},this.scene.metadata.behaviorScripts=this.scene.metadata.behaviorScripts||[],this.scene.metadata.behaviorScripts.push(asset.data),[2,asset]}})})},CodeExtension.prototype.onRenameAsset=function(asset,name){asset.data.name=name},CodeExtension.prototype.onGetAssets=function(){var data=this.onSerialize(),attached=[],unAttached=[];return data.scripts.forEach(function(s){if(data.nodes.find(function(n){return void 0!==n.metadatas.find(function(m){return m.codeId===s.id})}))return attached.push({name:s.name,data:s});unAttached.push({name:s.name,data:s})}),[{separator:"Attached"}].concat(attached).concat([{separator:"Unattached"}]).concat(unAttached)},CodeExtension.prototype.onDragAndDropAsset=function(targetMesh,asset){targetMesh.metadata=targetMesh.metadata||{},targetMesh.metadata.behavior||(targetMesh.metadata.behavior={node:targetMesh.name,metadatas:[]}),targetMesh.metadata.behavior.metadatas.push({codeId:asset.data.id,active:!0})},CodeExtension.prototype.onRemoveAsset=function(asset){var data=asset.data,remove=function(objects){objects.forEach(function(o){if(o.metadata&&o.metadata.behavior)for(var codes=o.metadata.behavior,links=codes.metadatas,i=0;i<links.length;i++)links[i].codeId===data.id&&(links.splice(i,1),i--)})};remove(this.scene.meshes),remove(this.scene.lights),remove(this.scene.cameras),remove([this.scene]),remove(this.scene.particleSystems);var index=this.scene.metadata.behaviorScripts.indexOf(data);-1!==index&&this.scene.metadata.behaviorScripts.splice(index,1)},CodeExtension.prototype.onAddAsset=function(asset){this.scene.metadata.behaviorScripts.push(asset.data)},CodeExtension.prototype.onApply=function(data){var _this=this;this.datas=data,this.datas.scripts.forEach(function(s){if(!EDITOR.BehaviorCode.Constructors[s.name.replace(/ /g,"")]){if(!_this.datas.nodes.find(function(n){return void 0!==n.metadatas.find(function(m){return m.codeId===s.id})})){var ctor=_this.getConstructor(s,null);_this.scriptsConstructors[s.name]=ctor}}}),this.datas.nodes.forEach(function(d){var node="Scene"===d.node?_this.scene:_this.scene.getNodeByID(d.nodeId)||_this.scene.getNodeByName(d.node);node||_this.scene.particleSystems.forEach(function(ps){return ps.name===d.node&&(node=ps)}),node||(node=_this.scene.getParticleSystemByID(d.nodeId)),node&&d.metadatas.forEach(function(m){if(m.active){var code=_this.datas.scripts.find(function(s){return s.id===m.codeId}),ctor=_this.getConstructor(code,node);if(!ctor.ctor&&"function"!=typeof ctor){var nodeName=node instanceof babylonjs_1.Scene?"Scene":node.name;return babylonjs_1.Tools.Warn('Script named "'+code.name+'" has been ignored on object "'+nodeName+'" as there is no exported script. Please use "exportScript(ctor);"')}var instance=new(ctor.ctor||ctor)(node,_this.scene);m.params&&_this.setCustomParams(m,instance),_this.instances[(node instanceof babylonjs_1.Scene?"scene":node.name)+code.name]=instance;var id=node instanceof babylonjs_1.Scene?"Scene":node.id;_this.objectsInstances[id]||(_this.objectsInstances[id]=[]),_this.objectsInstances[id].push(instance);var scope=_this;instance.start&&_this.scene.registerBeforeRender(function(){instance.start(),scope.scene.unregisterBeforeRender(this.callback)}),instance.update&&_this.scene.registerBeforeRender(function(){instance.update()}),instance.dispose&&node.onDisposeObservable&&node.onDisposeObservable.add(function(){instance.dispose()})}})})},CodeExtension.prototype.onSerialize=function(){var result={scripts:this.scene.metadata?this.scene.metadata.behaviorScripts||[]:[],nodes:[]},add=function(objects){objects.forEach(function(o){if(o.metadata&&o.metadata.behavior){var behavior=o.metadata.behavior;behavior.node=o instanceof babylonjs_1.Scene?"Scene":o instanceof babylonjs_1.Node?o.name:o.id,behavior.nodeId=o instanceof babylonjs_1.Scene?"Scene":o.id,result.nodes.push(behavior)}})};return add(this.scene.meshes),add(this.scene.lights),add(this.scene.cameras),add([this.scene]),add(this.scene.particleSystems),result},CodeExtension.prototype.onLoad=function(data){var _this=this;if(!data.scripts){var oldData=data;data={scripts:[],nodes:[]},oldData.forEach(function(od){var node={node:od.node,nodeId:od.node,metadatas:[]};od.metadatas.forEach(function(m){var id=babylonjs_1.Tools.RandomId();m.link||(data.scripts.push({name:m.name,id:id,code:m.code,compiledCode:m.compiledCode}),node.metadatas.push({codeId:id,active:m.active,params:m.params}))}),data.nodes.push(node)})}this.datas=data,this.scene.metadata=this.scene.metadata||{},this.scene.metadata.behaviorScripts=this.datas.scripts,this.datas.nodes.forEach(function(d){var node="Scene"===d.node?_this.scene:_this.scene.getNodeByID(d.nodeId)||_this.scene.getNodeByName(d.node);node||(node=_this.scene.getParticleSystemByID(d.node)),node&&(d.metadatas.forEach(function(m){}),node.metadata=node.metadata||{},node.metadata.behavior=d)})},CodeExtension.prototype.setCustomParams=function(m,instance){for(var p in m.params){var param=m.params[p];void 0!==param.w?instance[p]=new babylonjs_1.Vector4(param.x,param.y,param.z,param.w):void 0!==param.z?instance[p]=new babylonjs_1.Vector3(param.x,param.y,param.z):void 0!==param.y?instance[p]=new babylonjs_1.Vector2(param.x,param.y):void 0!==param.a?instance[p]=new babylonjs_1.Color4(param.r,param.g,param.b,param.a):void 0!==param.b?instance[p]=new babylonjs_1.Color3(param.r,param.g,param.b):instance[p]=m.params[p]}},CodeExtension.prototype.getConstructor=function(code,node,evaluate){var url=window.location.href;url=url.replace(babylonjs_1.Tools.GetFilename(url),"")+"behaviors/",url+=node?(node instanceof babylonjs_1.Scene?"scene/":node.name.replace(/ /g,"")+"/")+code.name.replace(/ /g,"")+".js":code.name+".js";var fnName=node?(node instanceof babylonjs_1.Scene?"scene":node.name.replace(/ /g,""))+code.name.replace(/ /g,""):code.name.replace(/ /g,""),effectiveCode=template.replace(/{{name}}/g,fnName).replace(/{{class}}/g,node?node.constructor.name:"").replace(/{{node}}/g,this._getEffectiveConstructorName(node)).replace(/{{code}}/g,code.compiledCode||code.code);return evaluate?new Function(effectiveCode)():extension_1.default.AddScript(effectiveCode,url),EDITOR.BehaviorCode.Constructors[fnName](this.scene,node,extensions_1.default.Tools,extensions_1.default.Mobile,require_1.editorRequire)},CodeExtension.prototype.getConstructorName=function(obj){var tokenizer=new tokenizer_1.default(obj.toString());return tokenizer.matchIdentifier("function")||tokenizer.token===tokenizer_1.TokenType.IDENTIFIER?tokenizer.identifier:"Unknown Constructor Name"},CodeExtension.prototype.getFinalTypeScriptCode=function(code,node){var fnName=(node instanceof babylonjs_1.Scene?"scene":node.name.replace(/ /g,""))+code.name.replace(/ /g,"");return template.replace("{{name}}",fnName).replace("{{node}}",this._getEffectiveConstructorName(node)).replace("{{code}}",code.code)},CodeExtension.prototype._getEffectiveConstructorName=function(obj){if(obj instanceof babylonjs_1.DirectionalLight)return"dirlight";if(obj instanceof babylonjs_1.HemisphericLight)return"hemlight";if(obj instanceof babylonjs_1.GroundMesh||obj instanceof babylonjs_1.InstancedMesh)return"mesh";var ctrName=obj&&obj.constructor?obj.constructor.name:"";return""===ctrName&&(ctrName=typeof obj),ctrName.toLowerCase()},CodeExtension.prototype._getFunctionParameters=function(fn){var tokenizer=new tokenizer_1.default(fn.toString()),result=[];if(!tokenizer.matchIdentifier("function")||!tokenizer.match(tokenizer_1.TokenType.IDENTIFIER)||!tokenizer.match(tokenizer_1.TokenType.PARENTHESIS))return[];for(;!tokenizer.match(tokenizer_1.TokenType.PARENTHESIS)&&(result.push(tokenizer.identifier),tokenizer.getNextToken(),tokenizer.match(tokenizer_1.TokenType.COMMA)););return result},CodeExtension.Instance=null,CodeExtension.CurrentDatas=null,CodeExtension}(extension_1.default);exports.default=CodeExtension,extensions_1.default.Register("BehaviorExtension",CodeExtension)}),$__System.registerDynamic("16",["d","17","e"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("d"),babylonjs_editor_1=$__require("17"),extensions_1=$__require("e"),Helpers=function(){function Helpers(){}return Helpers.UpdateMonacoTypings=function(editor,editedData,onlyNonAttached){void 0===editedData&&(editedData=null),void 0===onlyNonAttached&&(onlyNonAttached=!1);var scripts=editor.core.scene.metadata.behaviorScripts,extension=extensions_1.default.RequestExtension(editor.core.scene,"BehaviorExtension");if(scripts&&extension){var datas_1=extension.onSerialize();for(var k in babylonjs_editor_1.CodeEditor.CustomLibs){babylonjs_editor_1.CodeEditor.CustomLibs[k].dispose()}babylonjs_editor_1.CodeEditor.CustomLibs={},scripts.forEach(function(s){if(s!==editedData){if(onlyNonAttached){if(datas_1.nodes.find(function(n){return void 0!==n.metadatas.find(function(m){return m.codeId===s.id})}))return}var code='declare module "'+s.name+'" {'+s.code+"}";babylonjs_editor_1.CodeEditor.CustomLibs[s.name]=window.monaco.languages.typescript.typescriptDefaults.addExtraLib(code,s.name)}})}},Helpers.GetSceneMetadatas=function(scene){return scene.metadata=scene.metadata||{},scene.metadata},Helpers.CreatePreview=function(canvas){var engine=new babylonjs_1.Engine(canvas),scene=new babylonjs_1.Scene(engine),camera=new babylonjs_1.ArcRotateCamera("PreviewCamera",0,0,10,babylonjs_1.Vector3.Zero(),scene,!0);return camera.attachControl(canvas,!0,!1),{engine:engine,scene:scene,camera:camera}},Helpers}();exports.default=Helpers}),$__System.registerDynamic("a",["d","17","e","14","16"],!0,function($__require,exports,module){"use strict";var __extends=(this||self,exports&&exports.__extends||function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}()),__awaiter=exports&&exports.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=exports&&exports.__generator||function(thisArg,body){function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(t=_.trys,!(t=t.length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g};Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("d"),babylonjs_editor_1=$__require("17"),extensions_1=$__require("e");$__require("14");var helpers_1=$__require("16"),BehaviorCodeEditor=function(_super){function BehaviorCodeEditor(editor,targetNode,targetNodeAddScript,targetNodeSetScript){var _this=_super.call(this,"Code Editor")||this;return _this.editor=editor,_this.layout=null,_this.toolbar=null,_this.grid=null,_this.extension=null,_this.code=null,_this.template="// Some code",_this.node=null,_this.asset=null,_this.datas=null,_this.data=null,_this.onSelectObject=function(node){return node&&_this.selectObject(node)},_this.onSelectAsset=function(asset){return asset&&_this.selectAsset(asset)},_this._timeoutId=-1,_this.targetNode=targetNode,_this.targetNodeAddScript=targetNodeAddScript,_this.targetNodeSetScript=targetNodeSetScript,_this}return __extends(BehaviorCodeEditor,_super),BehaviorCodeEditor.prototype.close=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return this.toolbar.element.destroy(),this.grid.element.destroy(),this.layout.element.destroy(),this.code.dispose(),this.editor.core.onSelectObject.removeCallback(this.onSelectObject),this.editor.core.onSelectAsset.removeCallback(this.onSelectAsset),[4,_super.prototype.close.call(this)];case 1:return _a.sent(),[2]}})})},BehaviorCodeEditor.prototype.create=function(){return __awaiter(this,void 0,void 0,function(){var div,_a,_b,_this=this;return __generator(this,function(_c){switch(_c.label){case 0:return div=$(this.divElement),this.layout=new babylonjs_editor_1.Layout("Code"),this.layout.panels=[{type:"top",content:'<div id="CODE-BEHAVIOR-TOOLBAR"></div>',size:30,resizable:!1},{type:"left",content:'<div id="CODE-BEHAVIOR-LIST" style="width: 100%; height: 100%;"></div>',size:250,overflow:"auto",resizable:!0},{type:"main",content:'<div id="CODE-BEHAVIOR-EDITOR" style="width: 100%; height: 100%; overflow: hidden;"></div>',resizable:!0}],this.layout.build(div.attr("id")),this.layout.lockPanel("left","Loading...",!0),this.toolbar=new babylonjs_editor_1.Toolbar("CodeToolbar"),this.toolbar.items=[{id:"add-new",text:"Attach New Script",caption:"Attach New Script",img:"icon-add"},{id:"add-new-lib",text:"Add New Lib",caption:"Add New Lib",img:"icon-add"},{type:"break"},{id:"import",text:"Import from...",caption:"Import from...",img:"icon-add"},{id:"open-code-editor",text:"Open Code Editor",caption:"Open Code Editor",img:"icon-edit"}],this.toolbar.right="No object selected",this.toolbar.helpUrl="http://doc.babylonjs.com/resources/custom_scripts",this.toolbar.onClick=function(id){return _this.toolbarClicked(id)},this.toolbar.build("CODE-BEHAVIOR-TOOLBAR"),this.grid=new babylonjs_editor_1.Grid("CodeGrid",{toolbarReload:!1,toolbarSearch:!1,toolbarEdit:!1}),this.grid.columns=[{field:"name",caption:"Name",size:"80%",editable:{type:"string"}},{field:"active",caption:"Active",size:"20%",editable:{type:"checkbox"}}],this.grid.onClick=function(id){return _this.selectCode(id[0])},this.grid.onAdd=function(){return _this._importFrom([_this._getSerializedMetadatasFile()])},this.grid.onDelete=function(ids){return _this.delete(ids)},this.grid.onChange=function(id,value){return _this.change(id,value)},this.grid.build("CODE-BEHAVIOR-LIST"),this.layout.lockPanel("main"),_a=this,[4,this.createEditor()];case 1:return _a.code=_c.sent(),_b=this,[4,babylonjs_editor_1.Tools.LoadFile("./assets/templates/code/code-typescript.ts",!1)];case 2:return _b.template=_c.sent(),this.layout.unlockPanel("main"),this.editor.core.onSelectAsset.add(this.onSelectAsset),this.editor.core.onSelectObject.add(this.onSelectObject),this.editor.core.scene.metadata=this.editor.core.scene.metadata||{},this.editor.core.scene.metadata.behaviorScripts=this.editor.core.scene.metadata.behaviorScripts||[],this.extension=extensions_1.default.RequestExtension(this.editor.core.scene,"BehaviorExtension"),this.editor.assets.addTab(this.extension),this.targetNode||this.editor.core.currentSelectedObject?(this.selectObject(this.targetNode||this.editor.core.currentSelectedObject),this.layout.unlockPanel("left")):this.layout.lockPanel("left","No object selected"),this.targetNodeAddScript&&this.add(),this.targetNodeSetScript&&this._importFrom([this._getSerializedMetadatasFile()]),!BehaviorCodeEditor.CodeProjectEditor&&this.node&&this.asset||this.layout.lockPanel("main"),babylonjs_editor_1.VSCodeSocket.OnUpdateBehaviorCode=function(d){return __awaiter(_this,void 0,void 0,function(){var scripts,effective,compiledCode,needsUpdate;return __generator(this,function(_a){switch(_a.label){case 0:return scripts=this.editor.core.scene.metadata.behaviorScripts,effective=scripts.find(function(s){return s.id===d.id}),[4,babylonjs_editor_1.CodeEditor.TranspileTypeScript(d.code,d.name.replace(/ /,""),{module:"cjs",target:"es5",experimentalDecorators:!0})];case 1:return compiledCode=_a.sent(),(needsUpdate=!0,effective)?(needsUpdate=effective.code!==d.code,effective.code=d.code,effective.compiledCode=compiledCode,needsUpdate&&(this.data&&this.data.id===d.id||this.asset&&this.asset.id===d.id)&&this.code.setValue(d.code),[2]):(babylonjs_editor_1.VSCodeSocket.RefreshBehavior(scripts),[2])}})})},[2]}})})},BehaviorCodeEditor.prototype.onShow=function(targetNode,targetNodeAddScript,targetNodeSetScript){this.onResize(),this.targetNode=targetNode,targetNode&&this.selectObject(this.targetNode),targetNodeAddScript&&this.add(),targetNodeSetScript&&this._importFrom([this._getSerializedMetadatasFile()]),BehaviorCodeEditor.CodeProjectEditor&&this.layout.lockPanel("main")},BehaviorCodeEditor.prototype.onResize=function(){this.layout.element.resize()},BehaviorCodeEditor.prototype.toolbarClicked=function(id){return __awaiter(this,void 0,void 0,function(){var _a,asset;return __generator(this,function(_b){switch(_b.label){case 0:switch(_a=id){case"add-new":return[3,1];case"add-new-lib":return[3,3];case"import":return[3,5];case"open-code-editor":return[3,7]}return[3,8];case 1:return[4,this.add()];case 2:return _b.sent(),[3,9];case 3:return[4,this.editor.assets.addAsset(this.extension)];case 4:return asset=_b.sent(),asset&&this.selectAsset(asset.data),[3,9];case 5:return[4,this._importFrom()];case 6:return _b.sent(),[3,9];case 7:return this.editCode(),[3,9];case 8:return[3,9];case 9:return[2]}})})},BehaviorCodeEditor.prototype.selectAsset=function(asset){if(this.node=null,this.asset=asset,!asset)return this.selectObject(null);asset.code&&(this.layout.hidePanel("left"),this.datas={node:"Unknown",nodeId:"Unknown",metadatas:[{active:!0,codeId:asset.id}]},this.selectCode(0),this.layout.unlockPanel("left"),BehaviorCodeEditor.CodeProjectEditor||this.layout.unlockPanel("main"))},BehaviorCodeEditor.prototype.selectObject=function(node){var _this=this;if(!node)return this.layout.lockPanel("left","No object selected"),void this.layout.lockPanel("main");this.node=node,node.metadata=node.metadata||{},this.asset=null,this.datas=node.metadata.behavior,this.datas||(this.datas=node.metadata.behavior={node:node instanceof babylonjs_1.Scene?"Scene":node.name,nodeId:node instanceof babylonjs_1.Scene?"Scene":node.id,metadatas:[]}),this.datas.nodeId||(this.datas.nodeId=node instanceof babylonjs_1.Scene?"Scene":node.id),this.data=null,this.grid.element.clear(),this.code.setValue("");var scripts=this.editor.core.scene.metadata.behaviorScripts;this.datas.metadatas.forEach(function(d,index){var code=scripts.find(function(s){return s.id===d.codeId});_this.grid.addRecord({recid:index,name:code.name,active:d.active})}),this.grid.element.refresh(),this.datas.metadatas.length>0&&(this.selectCode(0),this.grid.select([0])),this.layout.showPanel("left"),this._updateToolbarText(),this.layout.unlockPanel("left"),0===this.datas.metadatas.length?this.layout.lockPanel("main"):BehaviorCodeEditor.CodeProjectEditor||this.layout.unlockPanel("main")},BehaviorCodeEditor.prototype.selectCode=function(index){var _this=this,scripts=this.editor.core.scene.metadata.behaviorScripts;this.data=scripts.find(function(s){return s.id===_this.datas.metadatas[index].codeId}),helpers_1.default.UpdateMonacoTypings(this.editor,this.data),this.code.setValue(this.data.code),this._updateToolbarText()},BehaviorCodeEditor.prototype.add=function(){return __awaiter(this,void 0,void 0,function(){var ctor,name,data,scripts;return __generator(this,function(_a){switch(_a.label){case 0:return ctor="scene",this.node&&(ctor=babylonjs_editor_1.Tools.GetConstructorName(this.node).toLowerCase(),this.node instanceof babylonjs_1.DirectionalLight?ctor="dirlight":this.node instanceof babylonjs_1.HemisphericLight?ctor="hemlight":(this.node instanceof babylonjs_1.GroundMesh||this.node instanceof babylonjs_1.InstancedMesh)&&(ctor="mesh")),[4,babylonjs_editor_1.Dialog.CreateWithTextInput("Script Name")];case 1:return name=_a.sent(),data={name:name,id:babylonjs_1.Tools.RandomId(),code:this.template.replace(/{{name}}/g,(name[0].toUpperCase()+name.substr(1,name.length)).replace(/ /g,"")).replace(/{{type}}/g,ctor).replace(/{{class}}/g,this.node.constructor.name)},scripts=this.editor.core.scene.metadata.behaviorScripts,scripts.push(data),this.node?(this.datas.metadatas.push({active:!0,codeId:data.id}),this.grid.addRow({recid:this.datas.metadatas.length-1,name:data.name,active:!0}),this.grid.selectNone(),this.grid.select([this.datas.metadatas.length-1]),this.selectCode(this.datas.metadatas.length-1),this.editor.graph.configure()):this.selectAsset(data),this.code.focus(),BehaviorCodeEditor.CodeProjectEditor||this.layout.unlockPanel("main"),this.editor.assets.refresh(this.extension.id),[2]}})})},BehaviorCodeEditor.prototype.delete=function(ids){return __awaiter(this,void 0,void 0,function(){var offset,_this=this;return __generator(this,function(_a){return offset=0,ids.forEach(function(id){_this.datas.metadatas.splice(id-offset,1),offset++}),this.editor.assets.refresh(this.extension.id),this.editor.graph.configure(),[2]})})},BehaviorCodeEditor.prototype.change=function(id,value){var _this=this;if("string"==typeof value){this.editor.core.scene.metadata.behaviorScripts.find(function(s){return s.id===_this.datas.metadatas[id].codeId}).name=value,this._updateToolbarText(),this.editor.assets.refresh(this.extension.id)}else this.datas.metadatas[id].active=value},BehaviorCodeEditor.prototype.createEditor=function(parent,data,caller){return __awaiter(this,void 0,void 0,function(){var code,_this=this;return __generator(this,function(_a){switch(_a.label){case 0:return caller=caller||window,code=new babylonjs_editor_1.CodeEditor("typescript",""),[4,code.build(parent||"CODE-BEHAVIOR-EDITOR",caller)];case 1:return _a.sent(),code.onChange=function(value){clearTimeout(_this._timeoutId),_this._timeoutId=setTimeout(function(){if(data||_this.data){var config={module:"cjs",target:"es5",experimentalDecorators:!0};data?data.compiledCode=code.transpileTypeScript(data.code,_this.data.name.replace(/ /,""),config):_this.data&&(_this.data.compiledCode=_this.code.transpileTypeScript(_this.data.code,_this.data.name.replace(/ /,""),config))}},500),data?(data.code=code.getValue(),data===_this.data&&_this.code.setValue(data.code)):_this.data&&(_this.data.code=_this.code.getValue(),babylonjs_editor_1.VSCodeSocket.RefreshBehavior(_this.data))},[2,code]}})})},BehaviorCodeEditor.prototype.editCode=function(){return __awaiter(this,void 0,void 0,function(){var editor,_this=this;return __generator(this,function(_a){switch(_a.label){case 0:return BehaviorCodeEditor.CodeProjectEditor?[2]:[4,babylonjs_editor_1.CodeProjectEditorFactory.Create(this.editor,{name:"Code Editor - Behaviors",scripts:this.editor.core.scene.metadata.behaviorScripts,onOpened:function(){_this.layout.lockPanel("main")},onClose:function(){BehaviorCodeEditor.CodeProjectEditor=null,(_this.node||_this.asset)&&_this.layout.unlockPanel("main")}})];case 1:return editor=_a.sent(),BehaviorCodeEditor.CodeProjectEditor=editor,[2]}})})},BehaviorCodeEditor.prototype._getSerializedMetadatasFile=function(){var result={customMetadatas:{BehaviorExtension:this.extension.onSerialize()}};return babylonjs_editor_1.Tools.CreateFile(babylonjs_editor_1.Tools.ConvertStringToUInt8Array(JSON.stringify(result)),"editorproject")},BehaviorCodeEditor.prototype._updateToolbarText=function(){this.toolbar.element.right="<h2>"+(this.data?this.data.name:"")+'</h2> Attached to "'+(this.node instanceof babylonjs_1.Scene?"Scene":this.node?this.node.name:"")+'"',this.toolbar.element.render()},BehaviorCodeEditor.prototype._importFrom=function(files){return __awaiter(this,void 0,void 0,function(){var importFromFile,_loop_1,this_1,_i,files_1,f,_this=this;return __generator(this,function(_a){switch(_a.label){case 0:return importFromFile=!1,files?[3,2]:(importFromFile=!0,[4,babylonjs_editor_1.Tools.OpenFileDialog()]);case 1:files=_a.sent(),_a.label=2;case 2:_loop_1=function(f){var content,project,metadatas,scripts,picker;return __generator(this,function(_a){switch(_a.label){case 0:return"editorproject"!==babylonjs_editor_1.Tools.GetFileExtension(f.name)?[2,"continue"]:[4,babylonjs_editor_1.Tools.ReadFileAsText(f)];case 1:return content=_a.sent(),(project=JSON.parse(content),project.customMetadatas&&project.customMetadatas.BehaviorExtension)?(metadatas=project.customMetadatas.BehaviorExtension,scripts=this_1.editor.core.scene.metadata.behaviorScripts,picker=new babylonjs_editor_1.Picker("Import Scripts From..."),picker.search=!0,picker.addItems(metadatas.scripts),picker.open(function(items){items.forEach(function(i){var code=importFromFile?metadatas.scripts[i.id]:scripts[i.id],id=importFromFile?babylonjs_1.Tools.RandomId():code.id;importFromFile&&(code.id=id,_this.extension.onAddAsset({data:code,name:code.name})),_this.datas&&_this.datas.metadatas.push({active:!0,codeId:id})}),_this.editor.assets.refresh(_this.extension.id),_this.editor.graph.configure(),_this.selectObject(_this.node)}),[2]):[2,"continue"]}})},this_1=this,_i=0,files_1=files,_a.label=3;case 3:return _i<files_1.length?(f=files_1[_i],[5,_loop_1(f)]):[3,6];case 4:_a.sent(),_a.label=5;case 5:return _i++,[3,3];case 6:return[2]}})})},BehaviorCodeEditor.CodeProjectEditor=null,BehaviorCodeEditor}(babylonjs_editor_1.EditorPlugin);exports.default=BehaviorCodeEditor})})(function(factory){module.exports=factory(require("babylonjs"),require("babylonjs-editor"),require("babylonjs-gui"),require("babylonjs-post-process"),require("cannon"),require("earcut"),require("extensions/extensions.js"))});