!function(e){function t(e){Object.defineProperty(this,e,{enumerable:!0,get:function(){return this[v][e]}})}function r(e){if("undefined"!=typeof System&&System.isModule?System.isModule(e):"[object Module]"===Object.prototype.toString.call(e))return e;var t={default:e,__useDefault:e};if(e&&e.__esModule)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return new o(t)}function o(e){Object.defineProperty(this,v,{value:e}),Object.keys(e).forEach(t,this)}function n(e){return"@node/"===e.substr(0,6)?c(e,r(m(e.substr(6))),{}):p[e]}function u(e){var t=n(e);if(!t)throw new Error('Module "'+e+'" expected, but not contained in build.');if(t.module)return t.module;var r=t.linkRecord;return i(t,r),a(t,r,[]),t.module}function i(e,t){if(!t.depLoads){t.declare&&d(e,t),t.depLoads=[];for(var r=0;r<t.deps.length;r++){var o=n(t.deps[r]);t.depLoads.push(o),o.linkRecord&&i(o,o.linkRecord);var u=t.setters&&t.setters[r];u&&(u(o.module||o.linkRecord.moduleObj),o.importerSetters.push(u))}return e}}function d(t,r){var o=r.moduleObj,n=t.importerSetters,u=!1,i=r.declare.call(e,function(e,t){if(!u){if("object"==typeof e)for(var r in e)"__useDefault"!==r&&(o[r]=e[r]);else o[e]=t;u=!0;for(var i=0;i<n.length;i++)n[i](o);return u=!1,t}},{id:t.key});"function"!=typeof i?(r.setters=i.setters,r.execute=i.execute):(r.setters=[],r.execute=i)}function l(e,t,r){return p[e]={key:e,module:void 0,importerSetters:[],linkRecord:{deps:t,depLoads:void 0,declare:r,setters:void 0,execute:void 0,moduleObj:{}}}}function f(e,t,r,o){var n={};return p[e]={key:e,module:void 0,importerSetters:[],linkRecord:{deps:t,depLoads:void 0,declare:void 0,execute:o,executingRequire:r,moduleObj:{default:n,__useDefault:n},setters:void 0}}}function s(e,t,r){return function(o){for(var n=0;n<e.length;n++)if(e[n]===o){var u,i=t[n],d=i.linkRecord;return u=d?-1===r.indexOf(i)?a(i,d,r):d.moduleObj:i.module,"__useDefault"in u?u.__useDefault:u}}}function a(t,r,n){if(n.push(t),t.module)return t.module;if(r.setters){for(var i=0;i<r.deps.length;i++){var d=r.depLoads[i],l=d.linkRecord;l&&-1===n.indexOf(d)&&a(d,l,l.setters?n:[])}r.execute.call(y)}else{var f={id:t.key},c=r.moduleObj;Object.defineProperty(f,"exports",{configurable:!0,set:function(e){c.default=c.__useDefault=e},get:function(){return c.__useDefault}});var p=s(r.deps,r.depLoads,n);if(!r.executingRequire)for(var i=0;i<r.deps.length;i++)p(r.deps[i]);var v=r.execute.call(e,p,c.__useDefault,f);void 0!==v?c.default=c.__useDefault=v:f.exports!==c.__useDefault&&(c.default=c.__useDefault=f.exports);var m=c.__useDefault;if(m&&m.__esModule)for(var b in m)Object.hasOwnProperty.call(m,b)&&(c[b]=m[b])}var f=t.module=new o(r.moduleObj);if(!r.setters)for(var i=0;i<t.importerSetters.length;i++)t.importerSetters[i](f);return f}function c(e,t){return p[e]={key:e,module:t,importerSetters:[],linkRecord:void 0}}var p={},v="undefined"!=typeof Symbol?Symbol():"@@baseObject";o.prototype=Object.create(null),"undefined"!=typeof Symbol&&Symbol.toStringTag&&(o.prototype[Symbol.toStringTag]="Module");var m="undefined"!=typeof System&&System._nodeRequire||"undefined"!=typeof require&&void 0!==require.resolve&&"undefined"!=typeof process&&process.platform&&require,y={};return Object.freeze&&Object.freeze(y),function(e,t,n,i){return function(d){d(function(d){var s={_nodeRequire:m,register:l,registerDynamic:f,registry:{get:function(e){return p[e].module},set:c},newModule:function(e){return new o(e)}};c("@empty",new o({}));for(var a=0;a<t.length;a++)c(t[a],r(arguments[a],{}));i(s);var v=u(e[0]);if(e.length>1)for(var a=1;a<e.length;a++)u(e[a]);return n?v.__useDefault:(v instanceof o&&Object.defineProperty(v,"__esModule",{value:!0}),v)})}}}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this)(["a"],["c","d","e","10"],!0,function($__System){this.require,this.exports,this.module;$__System.registerDynamic("b",["c","d","e"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),babylonjs_editor_1=$__require("d"),extensions_1=$__require("e"),Helpers=function(){function Helpers(){}return Helpers.UpdateMonacoTypings=function(editor,editedData,onlyNonAttached){void 0===editedData&&(editedData=null),void 0===onlyNonAttached&&(onlyNonAttached=!1);var scripts=editor.core.scene.metadata.behaviorScripts,extension=extensions_1.default.RequestExtension(editor.core.scene,"BehaviorExtension");if(scripts&&extension){var datas_1=extension.onSerialize();for(var k in babylonjs_editor_1.CodeEditor.CustomLibs){babylonjs_editor_1.CodeEditor.CustomLibs[k].dispose()}babylonjs_editor_1.CodeEditor.CustomLibs={},scripts.forEach(function(s){if(s!==editedData){if(onlyNonAttached){if(datas_1.nodes.find(function(n){return void 0!==n.metadatas.find(function(m){return m.codeId===s.id})}))return}var code='declare module "'+s.name+'" {'+s.code+"}";babylonjs_editor_1.CodeEditor.CustomLibs[s.name]=window.monaco.languages.typescript.typescriptDefaults.addExtraLib(code,s.name)}})}},Helpers.GetSceneMetadatas=function(scene){return scene.metadata=scene.metadata||{},scene.metadata},Helpers.CreatePreview=function(canvas){var engine=new babylonjs_1.Engine(canvas),scene=new babylonjs_1.Scene(engine),camera=new babylonjs_1.ArcRotateCamera("PreviewCamera",0,0,10,babylonjs_1.Vector3.Zero(),scene,!0);return camera.attachControl(canvas,!0,!1),{engine:engine,scene:scene,camera:camera}},Helpers}();exports.default=Helpers}),$__System.registerDynamic("f",["10","d"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var Raphael=$__require("10"),babylonjs_editor_1=$__require("d"),Timeline=function(){function Timeline(creator,root){this.creator=creator,this.timeLines=[],this.separators=[],this.systems=[],this.names=[],this.times=[],this._maxX=0,this._backgroundX=0,this._set=null,this.paper=Raphael(root,0,0),this.background=this.paper.rect(0,0,1,1),this.background.attr("fill","#aaa"),this.background.attr("stroke","#aaa"),this._onMoveBackground(),this.timeBackground=this.paper.rect(0,0,1,25),this.timeBackground.attr("fill","#777"),this.timeBackground.attr("stroke","#777"),this.playLine=this.paper.rect(0,0,1,1),this.playLine.attr("fill","#999"),this.playLine.attr("stroke","#999")}return Timeline.prototype.dispose=function(){this.paper.remove()},Timeline.prototype.resize=function(width,height){this.paper.setSize(width,height),this.background.attr("width",width),this.background.attr("height",height),this.timeBackground.attr("width",width),this.playLine.attr("height",height),this.setSet(this._set)},Timeline.prototype.setSet=function(set){var _this=this;if(set){var shouldPlay=this._set!==set;this._maxX=0,this._backgroundX=0,this._set=set,this.systems.forEach(function(s){return s.remove()}),this.systems=[],this.separators.forEach(function(s){return s.remove()}),this.separators=[],this.names.forEach(function(n){return n.remove()}),this.names=[],this.times.forEach(function(t){return t.remove()}),this.times=[],this.timeLines.forEach(function(t){return t.remove()}),this.timeLines=[],set.systems.forEach(function(s,i){var index=i+1,system=_this.paper.rect(0,40*index+1,100,35,16);if(system.attr("fill","#ddd"),system.attr("stroke-width",0),system.attr("x",s.startDelay/1e3*Timeline._Scale),system.data("bx",system.attr("x")),_this.systems.push(system),shouldPlay){var scaleFrom=Raphael.animation({transform:"s1.25,1.25"},300),strokeFrom=Raphael.animation({"stroke-width":5},300),scaleTo=Raphael.animation({transform:"s1,1"},300),strokeTo=Raphael.animation({"stroke-width":0},300);system.animate(scaleFrom.delay(s.startDelay)),system.animate(strokeFrom.delay(s.startDelay)),system.animate(scaleTo.delay(s.startDelay+301)),system.animate(strokeTo.delay(s.startDelay+301))}var name=_this.paper.text(0,0,s.name);name.attr("x",system.attr("x")+system.attr("width")/2-name.attr("width")/2),name.attr("y",system.attr("y")+system.attr("height")/2-name.attr("height")/2-10),name.data("bx",name.attr("x")),name.node.style.pointerEvents="none",_this.names.push(name);var time=_this.paper.text(0,0,s.startDelay+" (ms)");time.attr("x",system.attr("x")+system.attr("width")/2-time.attr("width")/2),time.attr("y",system.attr("y")+system.attr("height")/2-time.attr("height")/2+10),time.data("bx",name.attr("x")),time.node.style.pointerEvents="none",_this.times.push(time);var separator=_this.paper.rect(0,40*(index+1)-2.5,_this.paper.width,1);separator.attr("fill","#666"),separator.attr("stroke","#666"),_this.separators.push(separator),_this._onMoveSystem(s,system,name,time),_this._onShowSystemContextMenu(s,system),system.attr("x")>_this._maxX&&(_this._maxX=system.attr("x")+system.attr("width"))}),this._maxX<300&&(this._maxX=300);for(var steps=5,diff=Timeline._Scale/steps,end=this._maxX/diff*2,i=0;i<end;i++){var isSecond=i%steps==0,line=this.paper.rect(i*diff,0,1,isSecond?this.paper.height:this.timeBackground.attr("height")-15);if(line.attr("fill","#999"),line.attr("stroke-width",0),line.data("bx",line.attr("x")),this.timeLines.push(line),isSecond){var text=this.paper.text(0,20,(i/steps>>0)+" (s)");text.attr("x",i*diff+5+text.attr("width")),text.data("bx",text.attr("x")),text.node.style.pointerEvents="none",this.timeLines.push(text)}}this.playLine.transform("t0,0"),this.playLine.attr("x",0),this.playLine.toFront(),shouldPlay&&this.playLine.animate({transform:"t"+this._maxX+",0"},1e3*this._maxX/Timeline._Scale),this.systems.forEach(function(s){return s.toFront()}),this.names.forEach(function(n){return n.toFront()}),this.times.forEach(function(t){return t.toFront()})}},Timeline.prototype.onModifyingSystem=function(system){if(this._set){var index=this._set.systems.indexOf(system);if(-1!==index){var s=this.systems[index],n=this.names[index],t=this.times[index],diff=(system.startDelay-s.data("sd"))/1e3*Timeline._Scale;s.transform("t"+diff+",0"),n.transform("t"+diff+",0"),t.transform("t"+diff+",0")}}},Timeline.prototype.onModifiedSystem=function(system){if(this._set){-1!==this._set.systems.indexOf(system)&&this.setSet(this._set)}},Timeline.prototype._onMoveBackground=function(){var _this=this,lx=0,all=[],onStart=function(x,y,ev){all=_this._getAllMovableElements()},onMove=function(dx,dy,x,y,ev){lx=dx+_this._backgroundX,all.forEach(function(a){return a.attr("x",(a.data("bx")||0)+lx)})},onEnd=function(ev){_this._backgroundX=lx};this.background.drag(onMove,onStart,onEnd),this.background.node.addEventListener("wheel",function(ev){Timeline._Scale-=.05*ev.deltaY,Timeline._Scale<30&&(Timeline._Scale=30),_this.setSet(_this._set)})},Timeline.prototype._onMoveSystem=function(system,s,n,t){var _this=this,bx=s.attr("x"),ox=0,lx=0,onStart=function(x,y,ev){s.attr("opacity",.3),_this.systems.forEach(function(s){return s.attr("stroke-width",0)}),s.attr("stroke-width",2),_this.creator.editor.core.onSelectObject.notifyObservers(system)},onMove=function(dx,dy,x,y,ev){var ms=(bx+(dx+ox))/Timeline._Scale*1e3>>0;ms<0||(lx=dx+ox,s.transform("t"+lx+",0"),n.transform("t"+lx+",0"),t.transform("t"+lx+",0"),t.attr("text",ms+" (ms)"))},onEnd=function(ev){ox=lx,system.startDelay=(bx+ox)/Timeline._Scale*1e3>>0,s.attr("opacity",1),s.data("sd",system.startDelay),_this.creator.saveSet(),_this.creator.editor.inspector.currentObject===system&&_this.creator.editor.inspector.updateDisplay()};s.drag(onMove,onStart,onEnd)},Timeline.prototype._onShowSystemContextMenu=function(system,s){var _this=this;s.node.classList.add("ctxmenu"),s.node.addEventListener("contextmenu",function(ev){babylonjs_editor_1.ContextMenu.Show(ev,{clone:{name:"Clone",callback:function(){return _this.creator.cloneSystem(system)}},separator:"---------",remove:{name:"Remove",callback:function(){return _this.creator.removeSystemFromSet(system)}}})})},Timeline.prototype._getAllMovableElements=function(){for(var result=[],bot=this.paper.bottom;bot;)bot!==this.background&&bot!==this.timeBackground&&-1===this.separators.indexOf(bot)?(result.push(bot),bot=bot.next):bot=bot.next;return result},Timeline._Scale=100,Timeline}();exports.default=Timeline}),$__System.registerDynamic("a",["c","d","b","f"],!0,function($__require,exports,module){"use strict";var __extends=(this||self,exports&&exports.__extends||function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}()),__awaiter=exports&&exports.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=exports&&exports.__generator||function(thisArg,body){function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(t=_.trys,!(t=t.length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g};Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),babylonjs_editor_1=$__require("d"),helpers_1=$__require("b"),timeline_1=$__require("f"),ParticlesCreator=function(_super){function ParticlesCreator(editor,asset){void 0===asset&&(asset=null);var _this=_super.call(this,"Particle Systems Creator")||this;return _this.editor=editor,_this.layout=null,_this.toolbar=null,_this.tree=null,_this.tabs=null,_this.undoRedoId="particles-creator",_this.data=null,_this.preview=null,_this.set=null,_this.timeline=null,_this.currentParticleSystem=null,_this.onSelectAssetObserver=null,_this.data=asset,_this}return __extends(ParticlesCreator,_super),ParticlesCreator.prototype.close=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return this.layout.element.destroy(),this.toolbar.element.destroy(),this.preview.scene.dispose(),this.preview.engine.dispose(),this.timeline.dispose(),this.editor.core.onSelectAsset.remove(this.onSelectAssetObserver),this.editor.core.onModifyingObject.remove(this._modifyingObjectObserver),this.editor.core.onModifiedObject.remove(this._modifiedObjectObserver),[4,_super.prototype.close.call(this)];case 1:return _a.sent(),[2]}})})},ParticlesCreator.prototype.create=function(){return __awaiter(this,void 0,void 0,function(){var set,_this=this;return __generator(this,function(_a){switch(_a.label){case 0:return ParticlesCreator.DefaultSet?[3,2]:[4,babylonjs_editor_1.Tools.LoadFile("./assets/templates/particles-creator/default-set.json",!1)];case 1:set=_a.sent(),ParticlesCreator.DefaultSet=JSON.parse(set),_a.label=2;case 2:return this.layout=new babylonjs_editor_1.Layout(this.divElement.id),this.layout.panels=[{type:"top",size:30,resizable:!1,content:'<div id="PARTICLES-CREATOR-TOOLBAR" style="width: 100%; height: 100%"></div>'},{type:"left",size:"50%",resizable:!1,content:'\n                    <div id="PARTICLES-CREATOR-TREE" style="width: 100%; height: 100%;"></div>\n                    <div id="PARTICLES-CREATOR-TIMELINE" style="width: 100%; height: 100%; overflow: hidden;"></div>',tabs:[{id:"tree",caption:"List"},{id:"timeline",caption:"Timeline"}]},{type:"main",size:"50%",resizable:!1,content:'<canvas id="PARTICLES-CREATOR-CANVAS" style="width: 100%; height: 100%; position: absolute; top: 0;"></canvas>'}],this.layout.build(this.divElement.id),this.tabs=this.layout.getPanelFromType("left").tabs,this.tabs.on("click",function(ev){return _this.tabChanged(ev.target)}),this.tabs.select("timeline"),this.tabChanged("timeline"),this.toolbar=new babylonjs_editor_1.Toolbar("PARTICLES-CREATOR-TOOLBAR"),this.toolbar.helpUrl="https://doc.babylonjs.com/resources/using_particlesystemeditor",this.toolbar.items=[{id:"add",text:"Add System...",caption:"Add System...",img:"icon-add"},{id:"reset",text:"Reset",caption:"Reset",img:"icon-play-game"},{type:"break"},{id:"export",text:"Export As...",caption:"Export As...",img:"icon-export"},{id:"import",text:"Import From...",caption:"Import From...",img:"icon-add"},{type:"break"},{id:"preset",type:"menu",text:"Presets",caption:"Presets",img:"icon-particles",items:[{id:"smoke",text:"Smoke",caption:"Smoke"},{id:"sun",text:"Sun",caption:"Sun"},{id:"fire",text:"Fire",caption:"Fire"},{id:"explosion",text:"Explosion",caption:"Explosion"}]}],this.toolbar.onClick=function(id){return _this.toolbarClicked(id)},this.toolbar.build("PARTICLES-CREATOR-TOOLBAR"),this.toolbar.items.forEach(function(i){return _this.toolbar.enable(i.id,!1)}),this.tree=new babylonjs_editor_1.Tree("PARTICLES-CREATOR-TREE"),this.tree.wholerow=!0,this.tree.onClick=function(id,data){_this.currentParticleSystem=data,_this.editor.core.onSelectObject.notifyObservers(data)},this.tree.onCanDrag=function(){return!1},this.tree.onRename=function(id,name,data){return _this.currentParticleSystem.name=name,_this.resetSet(!0),!0},this.tree.onContextMenu=function(id,data){return[{id:"remove",text:"Remove",callback:function(){return _this.removeSystemFromSet(data)}}]},this.tree.build("PARTICLES-CREATOR-TREE"),this.timeline=new timeline_1.default(this,$("#PARTICLES-CREATOR-TIMELINE")[0]),this.preview=helpers_1.default.CreatePreview($("#PARTICLES-CREATOR-CANVAS")[0]),this.preview.camera.wheelPrecision=100,this.preview.engine.runRenderLoop(function(){return _this.preview.scene.render()}),this.onSelectAssetObserver=this.editor.core.onSelectAsset.add(function(a){return _this.selectAsset(a)}),this._modifyingObjectObserver=this.editor.core.onModifyingObject.add(function(o){_this.data&&(_this.timeline.onModifyingSystem(o),_this.saveSet())}),this._modifiedObjectObserver=this.editor.core.onModifiedObject.add(function(o){_this.data&&(_this.timeline.onModifiedSystem(o),_this.saveSet())}),this.data&&this.selectAsset(this.data),[2]}})})},ParticlesCreator.prototype.onHide=function(){},ParticlesCreator.prototype.onShow=function(asset){},ParticlesCreator.prototype.onResize=function(){this.layout.element.resize(),this.preview.engine.resize();var size=this.layout.getPanelSize("left");this.timeline.resize(size.width,size.height)},ParticlesCreator.prototype.toolbarClicked=function(id){return __awaiter(this,void 0,void 0,function(){var _a,name_1;return __generator(this,function(_b){switch(_b.label){case 0:switch(_a=id){case"add":return[3,1];case"reset":return[3,4];case"export":return[3,5];case"import":return[3,6];case"preset:smoke":return[3,7];case"preset:sun":return[3,8];case"preset:rain":return[3,9];case"preset:fire":return[3,10];case"preset:explosion":return[3,11]}return[3,12];case 1:return[4,babylonjs_editor_1.Dialog.CreateWithTextInput("Particle System name?")];case 2:return name_1=_b.sent(),[4,this.addSystemToSet(ParticlesCreator.DefaultSet.systems[0],name_1)];case 3:return _b.sent(),this.saveSet(),this.resetSet(!0),[3,12];case 4:return this.resetSet(!0),[3,12];case 5:return this.exportSet(),[3,12];case 6:return this.importSet(),[3,12];case 7:return this.createFromPreset("smoke"),[3,12];case 8:return this.createFromPreset("sun"),[3,12];case 9:return this.createFromPreset("rain"),[3,12];case 10:return this.createFromPreset("fire"),[3,12];case 11:return this.createFromPreset("explosion"),[3,12];case 12:return[2]}})})},ParticlesCreator.prototype.tabChanged=function(id){switch($("#PARTICLES-CREATOR-TREE").hide(),$("#PARTICLES-CREATOR-TIMELINE").hide(),id){case"tree":$("#PARTICLES-CREATOR-TREE").show();break;case"timeline":$("#PARTICLES-CREATOR-TIMELINE").show()}},ParticlesCreator.prototype.selectAsset=function(asset){var _this=this;if(!asset||!asset.psData)return void this.toolbar.items.forEach(function(i){return _this.toolbar.enable(i.id,!1)});this.toolbar.items.forEach(function(i){return _this.toolbar.enable(i.id,!0)}),this.data=asset,this.set&&(this.set.dispose(),this.set=null),this.resetSet(!0),this.timeline.setSet(this.set),babylonjs_editor_1.UndoRedo.ClearScope(this.undoRedoId)},ParticlesCreator.prototype.addSystemToSet=function(particleSystemData,name){var _this=this;if(this.set)return particleSystemData.id=babylonjs_1.Tools.RandomId(),new Promise(function(resolve){var rootUrl=particleSystemData.textureName?0===particleSystemData.textureName.indexOf("data:")?"":"file:":"",ps=babylonjs_1.ParticleSystem.Parse(particleSystemData,_this.preview.scene,rootUrl,!0);ps.emitter=ps.emitter||babylonjs_1.Vector3.Zero(),ps.name=name||ps.name,_this._cleanGradients(ps),_this.set.systems.push(ps),ps.particleTexture&&"file:"===rootUrl?ps.particleTexture.onLoadObservable.add(function(tex){return resolve(ps)}):resolve(ps)})},ParticlesCreator.prototype.removeSystemFromSet=function(ps){var index=this.set.systems.indexOf(ps);-1!==index&&(this.set.systems.splice(index,1),ps.dispose(),this.tree.remove(ps.id),this.saveSet(),this.resetSet(!0))},ParticlesCreator.prototype.cloneSystem=function(ps){return __awaiter(this,void 0,void 0,function(){var clone,e_1;return __generator(this,function(_a){switch(_a.label){case 0:return _a.trys.push([0,2,,3]),clone=ps.serialize(),[4,this.addSystemToSet(clone,ps.name+" Clone")];case 1:return _a.sent(),this.saveSet(),this.resetSet(!0),[3,3];case 2:return e_1=_a.sent(),babylonjs_editor_1.Window.CreateAlert("<h2>"+e_1.message+"</h2><br/>"+e_1.stack,"Can't clone the system"),[3,3];case 3:return[2]}})})},ParticlesCreator.prototype.resetSet=function(fillTree){return void 0===fillTree&&(fillTree=!1),__awaiter(this,void 0,void 0,function(){var data,_i,_a,s,ps,ps,_this=this;return __generator(this,function(_b){switch(_b.label){case 0:if(!this.data)return[2];data=this.set?this.set.serialize():this.data.psData,this.set&&(this.set.dispose(),this.preview.scene.particleSystems=[]),fillTree&&this.tree.clear(),this.set=new babylonjs_1.ParticleSystemSet,_i=0,_a=data.systems,_b.label=1;case 1:return _i<_a.length?(s=_a[_i],[4,this.addSystemToSet(s)]):[3,4];case 2:ps=_b.sent(),fillTree&&this.tree.add({id:ps.id,text:ps.name,data:ps,img:"icon-particles"}),_b.label=3;case 3:return _i++,[3,1];case 4:return this.set.start(),this.currentParticleSystem&&(ps=this.set.systems.find(function(ps){return ps.name===_this.currentParticleSystem.name}))&&(this.tree.select(ps.id),this.editor.core.onSelectObject.notifyObservers(ps)),this.timeline.setSet(this.set),[2]}})})},ParticlesCreator.prototype.saveSet=function(){this.data&&(this.data.psData=this.set.serialize())},ParticlesCreator.prototype.exportSet=function(){return __awaiter(this,void 0,void 0,function(){var serializationObject,embed,_i,_a,s,file_1,_b,_c,_d,s,json,file,textureFiles,_e,_f,s,file_2,storage;return __generator(this,function(_g){switch(_g.label){case 0:return this.data?(this.saveSet(),serializationObject=this.set.serialize(),[4,babylonjs_editor_1.Dialog.Create("Embed textures?","Do you want to embed textures in the set?")]):[2];case 1:if("Yes"!==(embed=_g.sent()))return[3,6];_i=0,_a=serializationObject.systems,_g.label=2;case 2:return _i<_a.length?(s=_a[_i],(file_1=babylonjs_1.FilesInputStore.FilesToLoad[s.textureName.toLowerCase()])?(_b=s,[4,babylonjs_editor_1.Tools.ReadFileAsBase64(file_1)]):[3,4]):[3,5];case 3:_b.textureName=_g.sent(),_g.label=4;case 4:return _i++,[3,2];case 5:return[3,7];case 6:for(_c=0,_d=serializationObject.systems;_c<_d.length;_c++)s=_d[_c],s.textureName="textures/"+s.textureName;_g.label=7;case 7:if(json=JSON.stringify(serializationObject,null,"\t"),file=babylonjs_editor_1.Tools.CreateFile(babylonjs_editor_1.Tools.ConvertStringToUInt8Array(json),this.data.name+".json"),"Yes"===embed)return[2,babylonjs_1.Tools.Download(file,file.name)];for(textureFiles=[],_e=0,_f=serializationObject.systems;_e<_f.length;_e++)s=_f[_e],(file_2=babylonjs_1.FilesInputStore.FilesToLoad[s.textureName.replace("textures/","").toLowerCase()])&&-1===textureFiles.indexOf(file_2)&&textureFiles.push(file_2);return[4,babylonjs_editor_1.Storage.GetStorage(this.editor)];case 8:return storage=_g.sent(),[4,storage.openPicker("Choose destination folder...",[{name:file.name,file:file},{name:"textures",folder:textureFiles.map(function(tf){return{name:tf.name,file:tf}})}])];case 9:return _g.sent(),[2]}})})},ParticlesCreator.prototype.importSet=function(){return __awaiter(this,void 0,void 0,function(){var files,_i,files_1,f,ext,content,_a,_b,_c,_d,s,path,filename,_e,_f,e_2;return __generator(this,function(_g){switch(_g.label){case 0:return this.layout.lockPanel("top","Importing..."),[4,babylonjs_editor_1.Tools.OpenFileDialog()];case 1:files=_g.sent(),_i=0,files_1=files,_g.label=2;case 2:return _i<files_1.length?(f=files_1[_i],"json"!==(ext=babylonjs_editor_1.Tools.GetFileExtension(f.name))?[3,11]:(_b=(_a=JSON).parse,[4,babylonjs_editor_1.Tools.ReadFileAsText(f)])):[3,12];case 3:if(content=_b.apply(_a,[_g.sent()]),!content.systems)return[3,11];_c=0,_d=content.systems,_g.label=4;case 4:if(!(_c<_d.length))return[3,10];if(s=_d[_c],!s.textureName||-1!==s.textureName.indexOf("data:"))return[3,8];path=babylonjs_editor_1.Tools.GetFilePath(f).replace(f.name,""),filename=babylonjs_editor_1.Tools.GetFilename(s.textureName),_g.label=5;case 5:return _g.trys.push([5,7,,8]),_e=babylonjs_1.FilesInputStore.FilesToLoad,_f=filename.toLowerCase(),[4,babylonjs_editor_1.Tools.GetFile(path+s.textureName)];case 6:return _e[_f]=_g.sent(),s.textureName=filename,[3,8];case 7:return e_2=_g.sent(),[3,9];case 8:this.addSystemToSet(s),_g.label=9;case 9:return _c++,[3,4];case 10:_g.label=11;case 11:return _i++,[3,2];case 12:return this.layout.unlockPanel("top"),this.saveSet(),this.resetSet(!0),[2]}})})},ParticlesCreator.prototype.createFromPreset=function(preset){return __awaiter(this,void 0,void 0,function(){var override,_a,promises,_loop_1,_i,_b,s,_this=this;return __generator(this,function(_c){switch(_c.label){case 0:return[4,babylonjs_editor_1.Dialog.Create("Override current set?","Setting from a preset will override your current set configuration. Are you sure?")];case 1:return"No"===(override=_c.sent())?[2]:(this.layout.lockPanel("top","Loading...",!0),this.set&&this.set.dispose(),_a=this,[4,babylonjs_1.ParticleHelper.CreateAsync(preset,this.preview.scene)]);case 2:for(_a.set=_c.sent(),this.set.systems.forEach(function(s){return _this._cleanGradients(s)}),promises=[],_loop_1=function(s){promises.push(new Promise(function(resolve){s.particleTexture.onLoadObservable.addOnce(function(tex){return __awaiter(_this,void 0,void 0,function(){var blob,split,name;return __generator(this,function(_a){switch(_a.label){case 0:return[4,babylonjs_editor_1.GraphicsTools.TextureToFile(tex)];case 1:return blob=_a.sent(),split=tex.name.split("/"),name=split[split.length-1],blob.name=tex.name=tex.url=name.toLowerCase(),babylonjs_1.FilesInputStore.FilesToLoad[name.toLowerCase()]=blob,resolve(),[2]}})})})}))},_i=0,_b=this.set.systems;_i<_b.length;_i++)s=_b[_i],_loop_1(s);return[4,Promise.all(promises)];case 3:return _c.sent(),this.saveSet(),this.resetSet(!0),this.layout.unlockPanel("top"),[2]}})})},ParticlesCreator.prototype._cleanGradients=function(system){var sizeGradients=system._sizeGradients;if(sizeGradients){var gradientsDict={};sizeGradients.forEach(function(sg){gradientsDict[sg.gradient]=gradientsDict[sg.gradient]||[],gradientsDict[sg.gradient].push(sg)}),sizeGradients.splice(0,sizeGradients.length);for(var k in gradientsDict){for(var g=gradientsDict[k];g.length>1;)g.pop();sizeGradients.push(g[0])}system._sizeGradients=sizeGradients}},ParticlesCreator.DefaultSet=null,ParticlesCreator}(babylonjs_editor_1.EditorPlugin);exports.default=ParticlesCreator})})(function(factory){module.exports=factory(require("babylonjs"),require("babylonjs-editor"),require("extensions/extensions.js"),require("raphael"))});